services:
  app:    
    container_name: app-e2e
    restart: always
    build:
      context: ..
      target: e2e
    image: ratewise:e2e
    ports:
      - ${SERVER_PORT:-3001}:3000
    depends_on:
      # - mailpit                    
      migrate:
        condition: service_completed_successfully
      redis:
        condition: service_started
    environment:      
      POSTGRES_URI: postgresql://test:testPass@postgres:5432/ratewise_e2e
      REDIS_URI: redis://redis:6379
    env_file:
      - path: ../.env.defaults
        required: true 
      - path: ../.env.e2e
        required: false       

  migrate:    
    container_name: migrate-e2e
    extends:
      file: ./compose.yml
      service: migrate
    environment:
      POSTGRES_URI: postgresql://test:testPass@postgres:5432/ratewise_e2e     

  postgres:    
    container_name: postgres-e2e
    extends: 
      file: ./compose.yml
      service: postgres 
    tmpfs: /var/lib/postgresql/data   
    environment:      
      POSTGRES_USER: test
      POSTGRES_PASSWORD: testPass
      POSTGRES_DB: ratewise_e2e
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U test -d ratewise_e2e"]
      interval: 10s
      retries: 5
      start_period: 30s
      timeout: 10s          

  redis:        
    container_name: redis-e2e
    extends: 
      file: ./compose.yml
      service: redis
    command: redis-server --appendonly no --save ""    
    tmpfs: /data

  # mailpit:    
  #   container_name: mailpit
  #   extends: 
  #     file: ./compose.yml
  #     service: mailpit
  #   restart: always
  #   volumes:
  #       - mailpit:/data
  #   ports:
  #       - "${MAILHOG_SMTP_PORT:-1025}:1025"
  #       - "${MAILHOG_UI_PORT:-8025}:8025"
  #   environment:
  #     MP_MAX_MESSAGES: 5000
  #     MP_DATABASE: /data/mailpit.db
  #     MP_SMTP_AUTH_ACCEPT_ANY: 1
  #     MP_SMTP_AUTH_ALLOW_INSECURE: 1   
  #     MP_SEND_API_AUTH_ACCEPT_ANY: 1    